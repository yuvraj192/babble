<!doctype html>
<html lang="en" xmlns:text-align="https://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat</title>
    <link rel="stylesheet" href="icons.css">
    <link rel="stylesheet" href="tailwind.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />
    <style>
        :root {
            --after: #f7fafc;
        }

        body {
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Old versions of Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
        }

        .chat-body {
            font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 20px;
            font-weight: normal;
            max-width: 450px;
            margin: 50px auto;
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            flex-direction: column;
        }

        p {
            max-width: 255px;
            word-wrap: break-word;
            margin-bottom: 12px;
            line-height: 24px;
            position: relative;
            padding: 10px 20px;
            border-radius: 25px;
            position: relative;
        }

        p:before,
        p:after {
            content: "";
            position: absolute;
            bottom: -2px;
            height: 20px;
        }

        .from-me {
            color: white;
            background: #7d4df9;
            align-self: flex-end;
        }

        .from-me.no-color {
            background-color: transparent !important;
            padding: 0pc !important;
        }

        .from-me:before {
            right: -7px;
            border-right: 20px solid #7d4df9;
            border-bottom-left-radius: 16px 14px;
            -webkit-transform: translate(0, -2px);
            transform: translate(0, -2px);
        }

        .from-me:after {
            right: -56px;
            width: 26px;
            background: var(--after);
            border-bottom-left-radius: 10px;
            -webkit-transform: translate(-30px, -2px);
            transform: translate(-30px, -2px);
        }

        .from-them {
            background: #E5E5EA;
            color: black;
            align-self: flex-start;
        }

        .from-me a,
        .from-them a {
            color: #42b0ff;
            cursor: pointer;
            text-decoration: none;
        }

        .dollar {
            color: #19ff55 !important;
        }

        .from-them:before {
            left: -7px;
            border-left: 20px solid #E5E5EA;
            border-bottom-right-radius: 16px 14px;
            -webkit-transform: translate(0, -2px);
            transform: translate(0, -2px);
        }

        .from-them:after {
            left: 4px;
            width: 26px;
            background: #f7fafc;
            border-bottom-right-radius: 10px;
            -webkit-transform: translate(-30px, -2px);
            transform: translate(-30px, -2px);
            z-index: 1 !important;
        }

        .from-them.no-color {
            background-color: transparent !important;
            margin-left: -30px !important;
        }

        .no-color:after {
            display: none;
        }

        .no-color:before {
            width: 0px;
            border-right: none;
            display: none;
        }

        .modal {
            transition: 5s ease all;
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 100;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
            position: fixed;
            background-color: #fefefe;
            /* 15% from the top and centered */
            bottom: 0;
            width: 100%;
            /* Could be more or less, depending on screen size */
            max-height: 400px;
            box-shadow: 0px 1px 4px -2px #333;
            text-shadow: 0px -1px #333;
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .pinSec,
        .pinsCont,
        .pin-img,
        .modal-content,
        .modal {
            transition: 0.2s cubic-bezier(0.62, 0.48, 0, 0.68) all !important;
        }

        .msg-img {
            width: 125px;
            height: 200px;
        }

        .from-them .msg-img {
            margin-left: 10px;
        }

        .from-me .msg-img {
            margin-left: 10px;
        }


        .cont-lrg-img {
            background-color: transparent !important;
            top: 10px !important;
            max-height: 80%;
            max-width: 100%;
            margin-top: 10%;
            margin-bottom: 10%;
            bottom: 10px;
            overflow-y: auto;
        }

        #output a {
            color: #42b0ff;
            cursor: pointer;
            text-decoration: none;
        }

        #output .attherate {
            padding: 5px;
            padding-left: 7px;
            padding-right: 7px;
            background-color: grey;
            border-radius: 8px;
            font-weight: bold;
        }

        #input {
            color: black
        }

        #output {
            position: absolute;
            z-index: 1;
            background-color: transparent;
            white-space: pre;
        }

        .msgReaction {
            position: absolute;
            bottom: -10px;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
        }

        .hashtag {
            color: cyan;
        }

        #anim {
            height: 90%;
            width: 100%;
            margin: 2em auto 0;
            position: fixed;
            top: 0px;
            left: 0px;
            bottom: 10%;
            z-index: 2000;
        }

        #anim span {
            width: 40px;
            height: 40px;
        }

        .audio-msg audio {
            max-width: 240px;
        }

        .audio-msg audio:focus {
            outline: none
        }

        .from-me.audio-msg,
        .from-them.audio-msg {
            padding: 10px !important;
            padding-top: 15px !important;
            padding-bottom: 15px !important;
        }

        .recordshadow {
            color: black !important;
            padding-left: 2rem;
            padding-right: 0.5rem;
        }

        .outer-2 {
            width: 25px;
            height: 25px;
            padding-left: 5px;
            -webkit-transform: scale(1);
            border-radius: 100%;
            position: absolute;
            z-index: 0;
            background-color: #7d4df9;
            transition: 1.5s all ease;
            -webkit-animation: woong-2 1.0s infinite;
            -webkit-animation-delay: 2.0s;
        }

        @-webkit-keyframes woong-2 {
            0% {
                -webkit-transform: scale(1.2);
                opacity: 0.6;
            }

            50% {
                -webkit-transform: scale(1.6);
                opacity: 0.5;
            }

            100% {
                -webkit-transform: scale(2);
                opacity: 0;
            }
        }

        #recordButton {
            position: relative;
        }

        .theme-shade-text {
            color: #7d4df9 !important;
        }
        .fullpage{
            height: 100%;
            width:100%
            padding-top:2.2% !important;
        }
        .prepage{
            margin-top:2%;
            height: 98%;
            width:90%;
            background-color:#dedede;
            padding-top:3% !important;
            transition:0.5s ease all;
        }
        .preTools{
            width:90%;
        }
        .subpage{
            height: 97.9%;
            width:95%;
            background-color:#fff;
            padding:2.9% !important;
            transition:0.5s ease all;
            z-index:9999;
        }
    </style>

</head>

<body id="chatCont" class="bg-gray-100">
<div class="mainChatCont">
<header class="text-gray-700 body-font pb-3 head shadow-lg bg-white fixed inset-x-0 top-0 z-10 header mx-auto"
        style="height:78px;">
    <div class="container absolute left-0 top-0 mx-auto flex p-1 flex-col items-center">
        <a
                class="flex order-first lg:order-none title-font font-medium items-center text-gray-900 lg:items-center lg:justify-center mb-4 mt-2 md:mb-0">
            <div class="rounded-lg overflow-hidden mr-2">
                <img alt="content" class="object-cover object-center bg-green-200 rounded-full todp"
                     style="height:40px;width:40px;" src="1.png">
            </div>
            <h2 class="title-font text-xs font-medium text-gray-900 mt-3 mb-3" id="contactName"></h2>
        </a>
        <nav class="flex items-center text-base fixed left-0 top-0 mt-5 ml-5">
            <a onclick="chat.close()" class="mr-5 theme-shade-text rounded-full text-sm"><i
                    class="material-icons">chevron_left</i></a>
        </nav>
        <div class="lg:w-2/5 inline-flex lg:justify-end ml-5 lg:ml-0 fixed right-0 top-0 mr-5  ">
            <button onclick="videoCall()"
                    class="inline-flex items-center bg-transparent border-0 py-1 px-3 focus:outline-none  rounded-full text-base mt-3 md:mt-0  ">
                <i class="material-icons">videocam</i>
            </button>
        </div>
    </div>
</header>

<section class="text-gray-700 body-font">
    <div class="container px-5 py-12 mx-auto overflow-x-hidden">
        <div class="flex flex-wrap -m-4 chat-body" id="chat_body"> </div>
    </div>
</section>

<div class="modal px-3" id="chat-settings">
    <div class="modal-content p-5 ml-1 rounded-lg animate__animated animate__bounceInUp"
         style="bottom:20px !important; max-width:92% !important;">
        <section class="text-gray-700 body-font overflow-auto">
            <div class="container mx-auto">
                <div class="flex flex-wrap -m-2">
                    <div onclick="unsendMessage()" class="p-2 lg:w-1/3 md:w-1/2 w-full border-t border-gray-300">
                        <div class="h-full flex items-center border-gray-200 p-4 text-red-500 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-red-500 object-cover object-center flex-shrink-0 rounded-full mr-4 unsendicon">delete</i>
                            <div class="flex-grow">
                                <h2 class="title-font font-medium">Unsend Message</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<div class="modal px-3 animate__animated animate__fadeIn animate__faster" id="large-image">
    <div class="modal-content cont-lrg-img p-5 ml-1 rounded-lg animate__animated animate__pulse"
         style="bottom:20px !important; max-width:92% !important;">
        <img src="" class="large_image rounded-lg" alt="">
    </div>
</div>

<div class="modal px-3 animate__animated animate__fadeIn animate__faster" id="large-video">
    <div class="modal-content cont-lrg-img p-5 ml-1 rounded-lg animate__animated animate__pulse"
         style="bottom:20px !important; max-width:92% !important;">
        <video src="" controls class="large_video rounded-lg" preload="metadata"></video>
    </div>
</div>

<footer class="text-gray-700 body-font fixed inset-x-0 bottom-0 px-2 z-10 pt-3 bg-white chatToolsFooter">
    <div onclick="$(this).hide()"
         class="emojiCenter flex py-1 mb-2 px-5 flex-wrap animate__animated animate__bounceInUp animate__faster pl-6 border-b border-gray-100 pb-4"
         style="display:none;">
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2 cancel">‚ùå</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">üòÇ</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">üòç</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">‚ù§</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">ü§¨</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">üò≠</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">üò±</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">üòë</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">ü§∑</span>
        <span class="emj text-sm w-1/9 h-6 w-6 mx-2">ü•∫</span>


    </div>
    <div class="flex rounded-full py-1 w-full float-left mb-2 pr-5">
            <span id="output"
                  class="break-words float-left placeholder-gray opacity-0 rounded-tl-full focus:outline-none rounded-bl-full text-black p-0 m-0"
                  style="max-width:100px;"></span>

        <button
                class="inline-flex oth items-center bg-transparent border-0 focus:outline-none mx-2 rounded-full text-base text-black md:mt-0 mr-4 ">
            <i class="material-icons">camera_alt</i>
        </button>
        <input placeholder="Message..."
               class="float-left msg placeholder-gray p-2 px-3 pl-5 w-3/4 rounded-full focus:outline-none " id="input"
               spellcheck="fasle" onkeyup="check()" oninput="check()" style="background: #f5f5f5;" />
        <div class="otherBtn flex">
            <div id="recordButton"
                 class="inline-flex items-center bg-transparent border-0 focus:outline-none mx-2 rounded-full text-base text-black md:mt-0  ">
                <div class="outer-2" style="display:none"></div>
                <button style="margin-top:7px;"><i class="material-icons">mic_none</i></button>
            </div>
            <button onclick="openGallery()"
                    class="inline-flex oth items-center bg-transparent border-0 focus:outline-none mx-2 rounded-full text-base text-black md:mt-0  ">

                <i class="material-icons">wallpaper</i>
            </button>
        </div>
        <button style="display:none;" onclick="sendMessage()"
                class="sndBtn inline-flex items-center bg-transparent border-0 focus:outline-none mx-2 rounded-full text-base text-blue-700 md:mt-0  animate__animated animate__fadeInRight animate__faster"
                style="margin-left:10px;">
            SEND
        </button>
    </div>
</footer>

<div id="anim" style="display:none;">
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
    <span class="w-1/9 h-6 w-6 mx-2"></span>
</div>
</div>
<div class="fixed inset-x-0 bottom-0 animate__animated animate__slideInUp animate__faster rounded-t-lg mx-auto galleryView subpage" style="display:none;">
    <button class="left-0 top-0 float-left text-red-700" onclick="deswitch('.galleryView')">Cancel</button>
</div>
</body>
<script src="jquery.js"></script>
<script>
    let root = document.documentElement;

    $(".msg").focus()
    $(".msg").click()
    var phoneNumber;
    var tonum;
    var ucid;
    var name;
    var longpress = 900;
    var inter;
    // holds the start time
    var start;
    var disableHold = false;
    var taken = false;

    window.onscroll = () => {
        if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
            $(".head").addClass("shadow-lg")
        } else {
            $(".head").removeClass("shadow--lg")
        }
    }
    document.onload = function () {
        document.body.scrollTop = document.body.scrollHeight;
    }

    function videoCall(){
        var ucid = [tonum, phoneNumber].sort().join('')
        video.call(`${tonum}`)
    }

    function check() {
        var msg = $(".msg").val()
        if (msg.length != 0) {
            $(".sndBtn").show()
            $(".otherBtn").hide()
            var str = $('.msg').val();
            str = str.replace(/(<)/gi, '&lt;');
            str = str.replace(/(<)/gi, '&lg;');
            str = str.replace(/(?:\r\n|\n\r|\r|\n)/g, '<br />');
            str = str.replace(/‚Çπ(.+?)(?=[\s.,:,]|$)/g,
                '<b class="dollar px-2 bg-gray-100 rounded-full animate__animated animate__fadeInDown">‚Çπ$1</b>');
            str = str.replace(/#(.+?)(?=[\s.,:,]|$)/g,
                '<b class="hashtag px-2 bg-gray-100 rounded-full animate__animated animate__bounce">#$1</b>');
            str = str.replace(/@(.+?)(?=[\s.,:,]|$)/g,
                '<a href="#" class="attherate px-2 bg-gray-100 rounded-full animate__animated animate__bounce">$1</a>'
            );
            str = str.replace(
                /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/g,
                '<a href="#">$1</a>');
            $('#output').html(`${str}`);
        } else if (msg.length == 0) {
            $(".sndBtn").hide()
            $(".otherBtn").show()
        }
    }

    $(".msg").keypress(function (event) {
        if (event.keyCode === 13) {
            sendMessage()
        }
        if (event.keyCode === 8) {
            check()
        }
    });

    function recieveMessage(msg, time, mid, from) {
        var chat;
        if(from != tonum) return
        if (mid.split("_")[0] == "audio") {
            chat =
                `<p id="${mid}" class="from-them audio-msg chat-bubble animate__animated animate__bounceInUp animate__faster"> <audio src="https://iotine.zapto.org:4600/files/${msg}" controls="true" controlsList="nodownload" type="audio/wav"></audio> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none"></span> </p>`
        } else if (mid.split("_")[0] == "img") {
            chat =
                `<p  id="${mid}" class="from-them no-color"> <img onclick="showImg(this.src)" class="rounded-lg msg-img animate__animated animate_jello" src="https://iotine.zapto.org:4600/files/${msg}" type="image/jpeg" /> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none"></span> </p>`
        } else {
            chat =
                `<p id="${mid}" class="from-them animate__animated animate__bounceInUp animate__faster">${msg} <span class="animate__animated animate__bounce msgReaction text-base" style="display:none"></span> </p>`
        }
        $(".chat-body").append(chat)
        $('html, body').animate({
            scrollTop: $('#chat_body').prop("scrollHeight")
        }, 1000);
        setTimeout(addListeners, 300)
    }

    async function sendMessage() {
        var cmsg = $("#output").html()
        if (cmsg == "" || cmsg == " ") return;
        var to = `${tonum}`
        var from = `${phoneNumber}`
        var timestamp = Date.now()

        var ID = '_' + Math.random().toString(36).substr(2, 9);

        await msg.send(`${cmsg}`, `${to}`, `${from}`, `${timestamp}`, `${ID}`)

        var chat =
            `<p id="${ID}" class="from-me chat-bubble animate__animated animate__bounceInUp animate__faster">${cmsg} <span class="animate__animated animate__bounce msgReaction text-base" style="display:none"></span> </p>`

        $(".chat-body").append(chat)
        $(".msg").val("")
        $("#output").html("")
        $(".msg").focus()
        $('html, body').animate({
            scrollTop: $('#chat_body').prop("scrollHeight")
        }, 100);
        device.vibrate()
        addListeners()
    }

    function unsendMessage() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                $(activeElm).hide('slow')
                $(activeElm).remove()
                msgg.delete(`${tonum}`, `${ucid}`, `${activeElm.id}`)
                root.style.setProperty('--active', "#f7fafc")
                taken = false;
            } else {
                taken = false;
                return
            }
        };
        xhttp.open("GET", "https://iotine.zapto.org:4600/deleteMsg/" + ucid + "/" + activeElm.id, true);
        xhttp.send();

    }

    var setModal = document.querySelector("#chat-settings")
    var imgModal = document.querySelector("#large-image")
    var videoModal = document.querySelector("#large-video")

    // Get the button that opens the modal
    var btn = document.getElementById("settings");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal

    // When the user clicks on <span> (x), close the modal

    setModal.onclick = function () {
        setModal.style.display = "none";
        $(activeElm).css("z-index", "0")
        taken = false;
    }

    imgModal.onclick = function () {
        imgModal.style.display = "none";
    }

    videoModal.onclick = function () {
        videoModal.style.display = "none";
    }


    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
        if (event.target == setModal) {
            setModal.style.display = "none";
            taken = false;
        }
    }

    function getChats(ucid) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var messages = JSON.parse(this.responseText)

                var ID = '_' + Math.random().toString(36).substr(2, 9);
                var templ;

                loadDp()
                messages.forEach(message => {
                    if (message.from == phoneNumber) {
                        if (message.mid.split("_")[0] == "audio") {
                            templ =
                                `<p id="${message.mid}" class="from-me audio-msg chat-bubble"> <audio src="https://iotine.zapto.org:4600/files/${message.data}" controls="true" controlsList="nodownload" type="audio/wav"></audio> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none">${message.reaction}</span> </p>`
                        } else if (message.mid.split("_")[0] == "img") {
                            templ =
                                `<p  id="${message.mid}" class="from-me no-color"> <img onclick="showImg(this.src)" class="rounded-lg msg-img animate__animated animate_jello" src="https://iotine.zapto.org:4600/files/${message.data}" type="image/jpeg" /> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none">${message.reaction}</span></p>`
                        } else {
                            templ =
                                `<p id="${message.mid}" class="from-me chat-bubble">${message.data} <span class="animate__animated animate__bounce msgReaction text-base" style="display:none">${message.reaction}</span> </p>`
                        }
                    } else if (message.to == phoneNumber) {
                        if (message.mid.split("_")[0] == "audio") {
                            templ =
                                `<p id="${message.mid}" class="from-them audio-msg chat-bubble"> <audio src="https://iotine.zapto.org:4600/files/${message.data}" controls="true" controlsList="nodownload" type="audio/wav"></audio> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none">${message.reaction}</span> </p>`
                        } else if (message.mid.split("_")[0] == "img") {
                            templ =
                                `<p  id="${message.mid}" class="from-them no-color"> <img onclick="showImg(this.src)" class="rounded-lg msg-img animate__animated animate_jello" src="https://iotine.zapto.org:4600/files/${message.data}" type="image/jpeg" /> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none">${message.reaction}</span></p>`
                        } else {
                            templ =
                                `<p id="${message.mid}" class="from-them">${message.data} <span class="animate__animated animate__bounce msgReaction text-base" style="display:none">${message.reaction}</span></p>`
                        }
                    }
                    $(".chat-body").prepend(templ)

                    if (typeof (message.reaction) != "undefined") {
                        document.querySelector(`#${message.mid}`).querySelector(".msgReaction").style
                            .display = "block";
                    }

                    $('html, body').animate({
                        scrollTop: $('#chat_body').prop("scrollHeight")
                    }, 0);
                    taken = false;
                    addListeners()
                })
            } else {
                return
            }
        };
        xhttp.open("GET", "https://iotine.zapto.org:4600/chats/" + ucid, true);
        xhttp.send();
    }

    function updateNumber(pno, toNum, name) {
        phoneNumber = pno;
        tonum = toNum;
        $("#contactName").html(name)
        name = name
        ucid = [tonum, pno].sort().join('')
        getChats(ucid)
    }

    function deleteMessage(from, _id) {
        $(`#${_id.id}`).removeClass('animate__bounceInUp')
        $(`#${_id.id}`).addClass('animate__fadeOut')

        document.querySelector(`#${_id.id}`).addEventListener('animationend', () => {
            $(`#${_id.id}`).remove()
        });
    }
    var likeelm;

    function addListeners() {
        taken = false
        document.querySelectorAll('.chat-bubble').forEach(item => {
            item.addEventListener('touchstart', event => {
                if (!taken) {
                    taken = true
                    start = new Date().getTime();
                    inter = setInterval(function () {
                        if (new Date().getTime() >= (start + longpress)) {
                            start = 0
                            clearInterval(inter)
                            root.style.setProperty('--active', "#000000")
                            $(item).css("z-index", "101")
                            document.querySelector("#chat-settings").style.display = "block"
                            device.vibrate()
                            activeElm = item
                        } else {}
                    }, 100);
                } else {
                    return
                }
            })
            item.addEventListener("touchend", event => {
                clearInterval(inter)
                start = 0
            })

        })
        document.querySelectorAll('.from-them').forEach(item => {
            item.addEventListener("dblclick", e => {
                if (document.querySelector(".emojiCenter").style.display == "none") {
                    document.querySelector(".emojiCenter").style.display = "block"
                    likeelm = item
                }
            })
        })

        document.querySelectorAll('img.msg-img').forEach(img => {
            img.addEventListener('touchstart', e => {
                var pr = $(img).parent().attr('id')
                if (!taken) {
                    taken = true
                    start = new Date().getTime();
                    inter = setInterval(function () {
                        if (new Date().getTime() >= (start + longpress)) {
                            start = 0
                            clearInterval(inter)
                            root.style.setProperty('--active', "#000000")
                            $(img).css("z-index", "101")
                            document.querySelector("#chat-settings").style.display = "block"
                            device.vibrate()
                            activeElm = document.querySelector(`#${pr}`)
                        } else {}
                    }, 100);
                } else {
                    return
                }
            })
            img.addEventListener('touchend', e => {
                var pr = $(img).parent().attr('id')
                clearInterval(inter)
                start = 0
            })
        })
      }

    function openGallery() {
        $('.galleryView').show()
        setTimeout(() => {
            //photo.Gallery()
            $('.chat-body').hide()
            $('body').removeClass('bg-gray-100').addClass('bg-black')
            $('.header').addClass('prepage rounded-t-lg')
            $('.chatToolsFooter').addClass('opacity-0')
        }, 350)
    }
    async function prevImage(url) {
        var mediaType = url.split("/")
        var to = `${tonum}`
        var from = `${phoneNumber}`
        var timestamp = Date.now()

        var ID = '_' + Math.random().toString(36).substr(2, 9);
        var chat;
        if (mediaType[4] == "video") {
           chat =
                `<p id="${ID}" class="from-me animate__animated animate_jello"> <span class="video-msg flex" onclick="playVideo('${url}')"> <i class="material-icons">play_arrow</i> Play video</span> </p>`
        } else if (mediaType[4] == "images" || mediaType[4] == "image") {
            chat =
                `<p  id="${ID}" class="from-me no-color"> <img onclick="showImg(this.src)" id="image${ID}" class="rounded-lg msg-img animate__animated animate_jello" src="${url}" /> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none"></span></p>`
            uploadImage(url, to, from, timestamp, ID);
        }

        $(".chat-body").append(chat)

        $('html, body').animate({
            scrollTop: $('#chat_body').prop("scrollHeight")
        }, 100);

        device.vibrate()
        taken = false
        addListeners()
    }

    function playVideo(url){
        $("#large-video").show();
        $(".large_video").attr("src", url)
    }

    function uploadImage(url, tonum, phoneNumber, timestamp, ID) {
        var img = new Image;
        var c = document.createElement("canvas");
        var ctx = c.getContext("2d");
        var filename = new Date().toISOString() + ".jpeg";

        img.onload = function () {
            c.width = this.naturalWidth; // update canvas size to match image
            c.height = this.naturalHeight;
            ctx.drawImage(this, 0, 0); // draw in image
            c.toBlob(function (blob) { // get content as JPEG blob
                var xhr = new XMLHttpRequest();
                xhr.onload = function (e) {
                    if (this.readyState === 4) {
                        msg.send(`${this.responseText}`, `${tonum}`, `${phoneNumber}`, `${timestamp}`,
                            `img${ID}`)
                    }
                };
                var fd = new FormData();
                fd.append("img_data", blob, filename);
                xhr.open("POST", "https://iotine.zapto.org:4600/imgmsg", true);
                xhr.send(fd);
            }, "image/jpeg", 0.75);
        };
        img.crossOrigin = "Anonymous"; // if from different origin
        img.src = url;
    }

    function showImg(src) {
        $("#large-image").show();
        $(".large_image").attr("src", src)
    }

    document.querySelectorAll('.emj').forEach(item => {
        item.addEventListener('click', event => {
            if (item.classList.contains('cancel')) {
                likeelm.querySelector(".msgReaction").innerHTML = ""
                react.onMessage(likeelm.id, "", `${tonum}`, `${phoneNumber}`)
            } else {
                likeelm.querySelector(".msgReaction").innerHTML = item.innerHTML
                react.onMessage(likeelm.id, item.innerHTML, `${tonum}`, `${phoneNumber}`)
                device.vibrate()
            }
            likeelm.querySelector(".msgReaction").style.display = "block"
            likeelm = ''
        })
    })

    function recieveReaction(mid, reaction) {
        document.querySelector(`#${mid}`).querySelector(".msgReaction").style.display = "none"
        document.querySelector(`#${mid}`).querySelector(".msgReaction").innerHTML = reaction
        animateEmojis(reaction)
        document.querySelector(`#${mid}`).querySelector(".msgReaction").style.display = ""
    }

    // shim layer with setTimeout fallback
    function animateEmojis(reaction) {
        if (reaction == "") return
        $('#anim').show();
        window.requestAnimationFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
        })();

        var $parent = $("#anim"),
            $elements = $('span', $parent),
            vertSpeed = 5,
            horiSpeed = 5;

        var height = $parent.height(),
            width = $parent.width();
        $parent.css("overflow", "hidden");

        // store all the data for animation
        var items = [];
        for (var i = 0; i < $elements.length; i++) {
            var $element = $($elements[i]),
                elementWidth = $element.width(),
                elementHeight = $element.height();


            $($element).html(reaction)

            $element.css("position", "absolute");

            var item = {
                element: $element[0],
                elementHeight: elementHeight,
                elementWidth: elementWidth,
                ySpeed: -vertSpeed,

                omega: 2 * Math.PI * horiSpeed / (width * 60), //omega= 2Pi*frequency
                random: (Math.random() / 2 + 0.5) * i * 10000, //random time offset
                x: function (time) {
                    return (Math.sin(this.omega * (time + this.random)) + 1) / 2 * (width - elementWidth);
                },
                y: height + (Math.random() + 1) * i * elementHeight,
            }
            items.push(item);
        }

        var counter = 0;
        var animationStep = function () { //called 60 times a second
            var time = +new Date(); //little trick, gives unix time in ms
            var check = (counter % 10 === 0);

            for (var i = 0; i < items.length; i++) {
                var item = items[i];

                transformString = "translate3d(" + item.x(time) + "px," + item.y + "px,0px)";
                item.element.style.transform = transformString;
                item.element.style.webkitTransform = transformString;

                item.y += item.ySpeed;
                if (check && item.y < -item.elementHeight) { //check bounds every 10th iteration
                    item.y = height;
                }
            }

            counter %= 10;
            counter++;
            requestAnimationFrame(animationStep);
        }
        setTimeout(function () {
            $('#anim').hide();
        }, 5000);
        requestAnimationFrame(animationStep);
    }
</script>
<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
<script>
    // VOICE MESSAGE

    //webkitURL is deprecated but nevertheless
    URL = window.URL || window.webkitURL;

    var gumStream; //stream from getUserMedia()
    var rec; //Recorder.js object
    var input; //MediaStreamAudioSourceNode we'll be recording
    var format;
    // shim for AudioContext when it's not avb.
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioContext //audio context to help us record

    var recordButton = document.getElementById("recordButton");

    //add events to those 2 buttons
    recordButton.addEventListener("touchstart", startRecording);
    recordButton.addEventListener("touchend", stopRecording);

    function startRecording() {
        audio.record()
        $(".outer-2").show()
        recordButton.classList.add("recordshadow")
        device.vibrate()
        console.log("recordButton clicked");

        /*
        	Simple constraints object, for more advanced audio features see
        	https://addpipe.com/blog/audio-constraints-getusermedia/
        */

        var constraints = {
            audio: true,
            video: false
        }

        /*
    	Disable the record button until we get a success or fail from getUserMedia()
	*/

        recordButton.disabled = true;

        /*
    	We're using the standard promise based getUserMedia()
    	https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
	*/

        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
            console.log("getUserMedia() success, stream created, initializing Recorder.js ...");

            /*
            	create an audio context after getUserMedia is called
            	sampleRate might change after getUserMedia is called, like it does on macOS when recording through AirPods
            	the sampleRate defaults to the one set in your OS for your playback device
            */
            audioContext = new AudioContext();

            //update the format
            format = "Format: 1 channel pcm @ " + audioContext
                .sampleRate / 1000 + "kHz"

            /*  assign to gumStream for later use  */
            gumStream = stream;

            /* use the stream */
            input = audioContext.createMediaStreamSource(stream);

            /*
            	Create the Recorder object and configure to record mono sound (1 channel)
            	Recording 2 channels  will double the file size
            */
            rec = new Recorder(input, {
                numChannels: 1
            })

            //start the recording process
            rec.record()

            console.log("Recording started");

        }).catch(function (err) {
            //enable the record button if getUserMedia() fails
            recordButton.disabled = false;
        });
    }

    function pauseRecording() {
        console.log("pauseButton clicked rec.recording=", rec.recording);
        if (rec.recording) {
            //pause
            rec.stop();
        } else {
            //resume
            rec.record()

        }
    }

    function stopRecording() {
        $(".outer-2").hide()
        recordButton.classList.remove("recordshadow")

        //disable the stop button, enable the record too allow for new recordings
        recordButton.disabled = false;

        //reset button just in case the recording is stopped while paused
        //tell the recorder to stop the recording
        rec.stop();

        //stop microphone access
        gumStream.getAudioTracks()[0].stop();

        //create the wav blob and pass it on to createDownloadLink
        rec.exportWAV(createDownloadLink);
    }

    function createDownloadLink(blob) {
        var ID = '_' + Math.random().toString(36).substr(2, 9);

        var url = URL.createObjectURL(blob);

        var filename = new Date().toISOString() + ".wav";

        var timestamp = Date.now()

        var xhr = new XMLHttpRequest();
        xhr.onload = function (e) {
            if (this.readyState === 4) {
                var chat =
                    `<p id="${ID}" class="from-me audio-msg chat-bubble animate__animated animate__bounceInUp animate__faster"> <audio src="https://iotine.zapto.org/Babble/uploads/${this.responseText}" controls="true" controlsList="nodownload" type="audio/wav"></audio> <span class="animate__animated animate__bounce msgReaction text-base" style="display:none"></span> </p>`

                msg.send(`${this.responseText}`, `${tonum}`, `${phoneNumber}`, `${timestamp}`, `audio${ID}`)
                $(".chat-body").append(chat)

                $('html, body').animate({
                    scrollTop: $('#chat_body').prop("scrollHeight")
                }, 100);

                device.vibrate()
                addListeners()
            }
        };
        var fd = new FormData();
        fd.append("audio_data", blob, filename);
        xhr.open("POST", "https://iotine.zapto.org:4600/audiomsg", true);
        xhr.send(fd);
    }
    function loadDp() {
        var xhr = new XMLHttpRequest();
        xhr.onload = function (e) {
            if (this.readyState === 4) {
                $(`.todp`).attr('src', `https://iotine.zapto.org:4600/files/${this.responseText}`)
            }
        };
        xhr.open("GET", "https://iotine.zapto.org:4600/dpOf/" + tonum, true);
        xhr.send();
    }
function deswitch(elm){
    $('.prepage').removeClass('prepage')
    $('.chat-body').show()
    $('body').removeClass('bg-black').addClass('bg-gray-100')
    $('.header').removeClass('rounded-t-lg')
    $('.chatToolsFooter').removeClass('opacity-0')
    $('html, body').animate({
        scrollTop: $('#chat_body').prop("scrollHeight")
    }, 100);
    $(elm).hide()
}
</script>

</html>