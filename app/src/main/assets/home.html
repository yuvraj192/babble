<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home</title>
    <link rel="stylesheet" href="icons.css">
    <link rel="stylesheet" href="tailwind.css">
    <script src="jquery.js"></script>
    <style>
        body {
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Old versions of Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
        }

        .modal {
            transition: 5s ease all;
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 100;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
            position: fixed;
            background-color: #fefefe;
            /* 15% from the top and centered */
            bottom: 0;
            width: 100%;
            /* Could be more or less, depending on screen size */
            max-height: 400px;
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .pinSec,
        .pinsCont,
        .pin-img,
        .modal-content,
        .modal {
            transition: 0.2s cubic-bezier(0.62, 0.48, 0, 0.68) all !important;
        }

        .tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  width: 60px;
  margin-left:15px;
  margin-top:20px;
  background-color: #E5E5EA;
  color: #000;
  text-align: center;
  border-radius: 16px 14px;
  padding-left: 6px;

  /* Position the tooltip */
  position: absolute;
  z-index: 1;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}
    </style>
</head>

<body>
<header class="text-gray-700 body-font bg-white fixed inset-x-0 top-0 z-10" style="height:56px;">
    <div class="container mx-auto flex p-5 flex-col items-center">
        <nav class="flex items-center text-base fixed left-0 top-0 ml-6 mt-5">
            <a id="settings" class="mr-5 rounded-full text-sm text-blue-500">Options</a>
        </nav>
        <a
                class="flex order-first lg:order-none lg:w-1/5 title-font font-medium items-center text-gray-900 lg:items-center lg:justify-center mb-4 md:mb-0">
            <span class="ml-2 text-xl -mt-2">Babble</span>
        </a>
        <div class="lg:w-2/5 inline-flex lg:justify-end ml-5 lg:ml-0 fixed right-0 top-0 mr-5 mt-2 ">
            <button onclick="newChat.add()"
                    class="inline-flex items-center bg-transparent border-0 py-1 px-3 focus:outline-none  rounded-full text-base md:mt-0 text-blue-500 ">
                <i class="material-icons">launch</i>
            </button>
        </div>
    </div>
</header>
<section class="text-gray-700 body-font mt-20 bg-white inset-x-0 pinSec" style="top:-24px !important;z-index-99;">
    <div class="container px-5 mx-auto">
        <div class="flex flex-wrap -m-4 overflow-y-auto pinsCont">

        </div>
    </div>
</section>
<section class="text-gray-700 body-font mt-4 bg-white">
    <div class="container px-5 py-2 mx-auto">
        <div class="flex flex-wrap -m-2 chats-cont">

        </div>
    </div>
</section>

<div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content px-5" onclick="return;"
         style="margin:0;border-top-left-radius: 30px;border-top-right-radius: 30px;">
        <div class="py-5 mx-auto flex flex-wrap flex-col md:flex-row items-center">
            <a
                    class="flex order-first lg:order-none lg:w-1/5 title-font font-medium items-center text-gray-900 lg:items-center lg:justify-center md:mb-0">
                <span class="ml-3 text-xl">Options</span>
            </a>
        </div>

        <hr class="mb-2">

        <section class="text-gray-700 body-font overflow-auto">
            <div class="container mx-auto">
                <div class="flex flex-wrap -m-2">
                    <div class="p-2 lg:w-1/3 md:w-1/2 w-full">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">group</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium">Create Group <i
                                        class="material-icons float-right">chevron_right</i> </h2>
                            </div>
                        </div>
                    </div>
                    <div onclick="profile.load()" class="p-2 lg:w-1/3 md:w-1/2 w-full">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">account_circle</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium"> My Profile <i
                                        class="material-icons float-right">chevron_right</i> </h2>
                            </div>
                        </div>
                    </div>
                    <div onclick="logout()" class="p-2 lg:w-1/3 md:w-1/2 w-full">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">exit_to_app</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium">Logout <i
                                        class="material-icons float-right">chevron_right</i> </h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

</div>

<div class="modal px-3" id="chat-settings">
    <div class="modal-content p-5 ml-1 rounded-lg" style="bottom:20px !important; max-width:92% !important;">
        <section class="text-gray-700 body-font overflow-auto">
            <div class="container mx-auto">
                <div class="flex flex-wrap -m-2">
                    <div class="p-2 lg:w-1/3 md:w-1/2 w-full">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">group</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium">Add to Group <i
                                        class="material-icons float-right">chevron_right</i> </h2>
                            </div>
                        </div>
                    </div>
                    <div class="p-2 lg:w-1/3 md:w-1/2 w-full">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">account_circle</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium"> Profile <i
                                        class="material-icons float-right">chevron_right</i> </h2>
                            </div>
                        </div>
                    </div>
                    <div onclick="addPin()" class="p-2 lg:w-1/3 md:w-1/2 w-full mpin">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">pin_drop</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium">Pin</h2>
                            </div>
                        </div>
                    </div>
                    <div onclick="removePin()" class="p-2 lg:w-1/3 md:w-1/2 w-full munpin" style="display:none;">
                        <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-black object-cover object-center flex-shrink-0 rounded-full mr-4">pin_drop</i>
                            <div class="flex-grow">
                                <h2 class="text-gray-900 title-font font-medium">Unpin</h2>
                            </div>
                        </div>
                    </div>
                    <div onclick="deleteChat()" class="p-2 lg:w-1/3 md:w-1/2 w-full border-t border-gray-300">
                        <div class="h-full flex items-center border-gray-200 p-4 text-red-500 rounded-lg">
                            <i alt="team"
                               class="material-icons w-8 h-8 text-red-500 object-cover object-center flex-shrink-0 rounded-full mr-4">delete</i>
                            <div class="flex-grow">
                                <h2 class="title-font font-medium">Delete Chat </h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
        var phoneNumber;

        function logout() {
            if (phoneNumber == "") return;
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    app.logout();
                } else {
                    return
                }
            };
            xhttp.open("GET", "http://iotine.zapto.org:4600/logout/" + phoneNumber, true);
            xhttp.send();
        }
        var activeElm;
        var times = 0;

        function openChat(item) {
            if(times > 0) return
            times = 1
            var num = item.id.split("_")[0]
            taken = false;
            chat.load(num, $(`.${num}_name`).html())
            window.location.reload()
        }

        // Get the modal
        var modal = document.getElementById("myModal");
        var setModal = document.querySelector("#chat-settings")

        // Get the button that opens the modal
        var btn = document.getElementById("settings");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on the button, open the modal
        btn.onclick = function () {
            $("#myModal").show('fast')
        }

        // When the user clicks on <span> (x), close the modal
        modal.onclick = function () {
            modal.style.display = "none";
        }
        setModal.onclick = function () {
            setModal.style.display = "none";
            $(activeElm).css("z-index", "0")
            taken = false;
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        var longpress = 900;
        var inter;
        // holds the start time
        var start;
        var disableHold = false;
        var taken = false;

        addListeners()

        window.onscroll = function () {
            disableHold = true
            scrollFunction()
        };

        function scrollFunction() {
            if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
                $(".pinSec").addClass("fixed h-12 shadow-sm z-10")
                $(".pinsCont").removeClass("flex-wrap")
                $(".pin-chat").removeClass("w-1/3").addClass("w-1/9")
                $(".pin-img").removeClass("chat-item")
                $(".pin-img").css("height", "2.5rem")
                $(".pin-img").css("width", "2.5rem")
            } else {
                $(".pinSec").removeClass("fixed h-12 shadow-sm")
                $(".pinsCont").addClass("flex-wrap")
                $(".pin-chat").removeClass("w-1/9").addClass("w-1/3")
                $(".pin-img").addClass("chat-item")
                $(".pin-img").css("height", "6rem")
                $(".pin-img").css("width", "6rem")
                disableHold = false;
            }
        }

        function updateNumber(pno) {
            phoneNumber = pno;
            getChatList()
        }

        function addPin() {
            var ID = '_' + Math.random().toString(36).substr(2, 9);
            var templ = `<div style="display:none;" id="${activeElm.id}" class="${ID} w-1/3 p-4 chat-item pin-chat">
                <a class="tooltip block relative h-24 w-24 rounded-full overflow-hidden pin-img">
                    <span style="display:none;" class="tooltiptext truncate ${activeElm.id.split('_')[0]}_pintip"></span>
                    <img alt="ecommerce" class="avt-img object-cover object-center w-full h-full block bg-green-200"
                         src="1.png">
                </a>
            </div>`

            $(".pinsCont").append(templ)
            $(`.${ID}`).show('fast')
            $(activeElm).hide('slow')
            $(activeElm).remove()
            taken = false
            addListeners()
        }

        function removePin() {
            var ID = '_' + Math.random().toString(36).substr(2, 9);
            var templ = `<div id="${activeElm.id}" class="${ID} lg:w-1/3 md:w-1/2 w-full chat-item bg-white rounded-lg" style="display:none;">
                <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                    <img alt="team"
                         class="w-12 h-12 bg-gray-100 object-cover object-center flex-shrink-0 rounded-full mr-4"
                         src="1.png">
                    <div class="flex-grow border-b pb-2">
                        <h2 class="text-gray-900 title-font font-bold ${activeElm.id.split('_')[0]}_name"></h2>
                        <p class="text-gray-500">UI Designer</p>
                    </div>
                </div>
            </div>`

            $(".chats-cont").prepend(templ)
            contacts.getName(activeElm.id.split('_')[0])
            $(`.${ID}`).show('fast')
            $(activeElm).hide('slow')
            $(activeElm).remove()
            taken = false;
            addListeners()
        }

        function deleteChat() {
            $(activeElm).hide('slow')
            $(activeElm).remove()
            taken = false;
        }

        function addListeners() {
            taken = false
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('touchstart', event => {
                    if (!taken) {
                        taken = true
                        start = new Date().getTime();
                        inter = setInterval(function () {
                            if (new Date().getTime() >= (start + longpress)) {
                                start = 0
                                clearInterval(inter)
                                $(item).css("z-index", "101")
                                $("#chat-settings").show()

                                if ($(item).hasClass("pin-chat")) {
                                    $(".mpin").hide()
                                    $(".munpin").show()
                                } else {
                                    $(".mpin").show()
                                    $(".munpin").hide()
                                }
                                device.vibrate()
                                activeElm = item
                            } else {}
                        }, 100);
                    } else {
                        return
                    }
                })
                item.addEventListener("touchend", event => {
                    clearInterval(inter)
                    start = 0
                })
                item.addEventListener("click", function() { openChat(item) })
            })
        }

        async function getChatList() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    $(".chats-cont").html("")
                    var messages = JSON.parse(this.responseText);

                    messages.forEach(message => {
                    contacts.getName(message)
                        var ID = '_' + Math.random().toString(36).substr(2, 9);
                        var templ = `<div id="${message}_message" class="${ID} lg:w-1/3 md:w-1/2 w-full chat-item bg-white rounded-lg" style="display:none;">
                                    <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                                        <img alt="team"
                                             class="w-12 h-12 bg-gray-100 object-cover object-center flex-shrink-0 rounded-full mr-4"
                                        src="1.png">
                                        <div class="flex-grow border-b pb-2">
                                            <h2 class="text-gray-900 title-font font-bold ${message}_name">${message}</h2>
                                            <p class="text-gray-500">UI Designer</p>
                                        </div>
                                    </div>
                                 </div>`

                    $(".chats-cont").append(templ)
                    $(`.${ID}`).show('fast')
                    taken = false;
                    addListeners()
                    })

                } else if (this.status == 404) {
                 $(".chats-cont").html("")
                var templ = `<div id="add_message" class="${ID} lg:w-1/3 md:w-1/2 w-full chat-item bg-white rounded-lg" style="display:none;">
                                    <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                                        <div class="flex-grow border-b pb-2">
                                            <h2 class="text-gray-900 title-font font-bold add_name">Start a new chat</h2>
                                        </div>
                                    </div>
                                 </div>`

                    $(".chats-cont").append(templ)
                    return
                }
            };
            xhttp.open("GET", "http://iotine.zapto.org:4600/chatListOF/" + phoneNumber, true);
            await xhttp.send();
        }

        function updateChatList(message, name, msg){
        if($(`#${message}_message`).hasClass('pin-chat')){
            $(`.${message}_pintip`).html(msg)
            $(`.${message}_pintip`).show('fast')
        }else{
            if($('.chats-cont').first().attr('id') != `${message}_message`){
                $(`#${message}_message`).hide('fast')
                $(`#${message}_message`).remove()
            }

            var ID = '_' + Math.random().toString(36).substr(2, 9);
            var templ = `<div id="${message}_message" class="${ID} lg:w-1/3 md:w-1/2 w-full chat-item bg-white rounded-lg" style="display:none;">
                                    <div class="h-full flex items-center border-gray-200 p-4 rounded-lg">
                                        <img alt="team"
                                             class="w-12 h-12 bg-gray-100 object-cover object-center flex-shrink-0 rounded-full mr-4"
                                        src="1.png">
                                        <div class="flex-grow border-b pb-2">
                                            <h2 class="text-gray-900 title-font font-bold ${message}_name">${name}</h2>
                                            <p class="text-black font-bold">${msg}</p>
                                        </div>
                                    </div>
                                 </div>`
                    $(".chats-cont").prepend(templ)
                    $(`.${ID}`).show('fast')
                    taken = false;
                    addListeners()
             }
        }

        function updateName(name, num){
            $(`.${num}_name`).html(name)
        }
    </script>
</body>

</html>